<!DOCTYPE html>
<html lang="en" data-theme="standard">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nova Drill Control</title>
    <style>
        /* --- THEME DEFINITIONS --- */
        :root { --trans-speed: 0.3s; }
        [data-theme="standard"] { --primary: #ff6b4a; --primary-dim: rgba(255, 107, 74, 0.1); --bg: #f5f6fa; --surface: #ffffff; --card-bg: #e4e7eb; --text: #2d3436; --text-light: #636e72; --border: #dfe6e9; --shadow: rgba(0,0,0,0.05); --danger: #d63031; --btn-text: #4a4a4a; --menu-bg: rgba(255, 255, 255, 0.98); --ring-track: #dfe6e9; --ring-color: #ff6b4a; }
        [data-theme="ocean"] { --primary: #0984e3; --primary-dim: rgba(9, 132, 227, 0.1); --bg: #f0f9ff; --surface: #ffffff; --card-bg: #dfe6e9; --text: #2c3e50; --text-light: #576574; --border: #c7ecee; --shadow: rgba(9, 132, 227, 0.1); --danger: #ff7675; --btn-text: #2c3e50; --menu-bg: rgba(255, 255, 255, 0.98); --ring-track: #c7ecee; --ring-color: #0984e3; }
        [data-theme="forest"] { --primary: #00b894; --primary-dim: rgba(0, 184, 148, 0.1); --bg: #f1f2f6; --surface: #ffffff; --card-bg: #ced6e0; --text: #2f3542; --text-light: #747d8c; --border: #a4b0be; --shadow: rgba(0, 184, 148, 0.1); --danger: #ff6b6b; --btn-text: #2f3542; --menu-bg: rgba(255, 255, 255, 0.98); --ring-track: #a4b0be; --ring-color: #00b894; }
        [data-theme="night"] { --primary: #ff7675; --primary-dim: rgba(255, 118, 117, 0.15); --bg: #1e272e; --surface: #2f3640; --card-bg: #353b48; --text: #f5f6fa; --text-light: #dcdde1; --border: #4b6584; --shadow: rgba(0,0,0,0.3); --danger: #e17055; --btn-text: #f5f6fa; --menu-bg: rgba(47, 54, 64, 0.98); --ring-track: #4b6584; --ring-color: #ff7675; }
        
        /* --- GLOBAL STYLES --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px 15px; box-sizing: border-box; transition: background-color var(--trans-speed), color var(--trans-speed); }
        .container { width: 100%; max-width: 500px; position: relative; padding-bottom: 80px; }
        
        header { display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 20px; padding: 0 10px; }
        h1 { margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--text); }
        .menu-btn { position: absolute; right: 0; color: var(--text-light); cursor: pointer; padding: 5px; z-index: 101; display: flex; align-items: center; justify-content: center; }
        .menu-btn svg { width: 24px; height: 24px; }

        .theme-menu { position: absolute; top: 50px; right: 10px; width: 180px; background: var(--menu-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 10px; display: flex; flex-direction: column; gap: 5px; z-index: 100; border: 1px solid var(--border); opacity: 0; transform: scale(0.8); pointer-events: none; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: top right; }
        .theme-menu.open { opacity: 1; transform: scale(1); pointer-events: auto; }
        .menu-title { font-size: 0.7rem; color: var(--text-light); font-weight: 700; padding: 5px 10px; border-bottom: 1px solid var(--border); margin-bottom: 5px; text-transform: uppercase; }
        .theme-item { padding: 10px; border-radius: 10px; cursor: pointer; font-size: 0.9rem; font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
        .theme-item:hover { background: var(--primary-dim); color: var(--primary); }
        .color-preview { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .reset-item { color: var(--danger); }
        .reset-item:hover { background: rgba(214, 48, 49, 0.1); color: var(--danger); }

        .settings-card { background: var(--card-bg); border-radius: 20px; padding: 15px; margin-bottom: 20px; transition: background-color var(--trans-speed); }
        .btn-connect { width: 100%; padding: 12px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; font-size: 0.95rem; background: var(--primary); color: white; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: background var(--trans-speed), transform 0.1s; }
        .btn-connect.connected { background: #00b894; }
        .control-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; transition: opacity 0.3s; }
        .controls-row { display: flex; gap: 10px; margin-bottom: 5px; }
        .control-pill { background: var(--surface); border-radius: 15px; padding: 10px; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 2px 5px var(--shadow); }
        .control-pill label { font-size: 0.65rem; color: var(--text-light); margin-bottom: 4px; font-weight: 700; text-transform: uppercase; }
        input[type="number"] { border: none; font-size: 1.1rem; font-weight: 800; color: var(--primary); text-align: center; width: 100%; background: transparent; }
        input[type="number"]:focus { outline: none; }
        
        .mode-switch { display: flex; background: rgba(0,0,0,0.05); border-radius: 20px; padding: 3px; width: 100%; margin-bottom: 10px; }
        [data-theme="night"] .mode-switch { background: rgba(255,255,255,0.1); }
        .mode-option { flex: 1; text-align: center; padding: 8px; font-size: 0.75rem; border-radius: 18px; cursor: pointer; color: var(--text-light); font-weight: 600; transition: all var(--trans-speed); }
        .mode-option.active { background: var(--surface); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .level-select { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; }
        .lvl-dot { width: 32px; height: 32px; border-radius: 50%; background: var(--surface); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; color: var(--text-light); cursor: pointer; border: 2px solid transparent; box-shadow: 0 2px 5px var(--shadow); transition: all var(--trans-speed); }
        .lvl-dot.active { border-color: var(--primary); color: var(--primary); transform: scale(1.1); }

        .section-label { font-size: 0.85rem; font-weight: 600; color: var(--text-light); margin-bottom: 8px; padding-left: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* SCROLLABLE TABS */
        .tabs-container { 
            background: var(--card-bg); 
            border-radius: 20px; 
            padding: 10px; 
            margin-bottom: 20px; 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 10px; 
        }
        .tab-btn { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 4px; 
            padding: 12px 5px; 
            border-radius: 16px; 
            border: 1px solid transparent; 
            background: transparent; 
            color: var(--text-light); 
            font-weight: 600; 
            font-size: 0.75rem; 
            cursor: pointer; 
            transition: all var(--trans-speed); 
            text-align: center;
        }
        .tab-btn.active { 
            background: var(--surface); 
            border: 1px solid var(--primary); 
            color: var(--primary); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }
        .icon-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; width: 10px; height: 10px; margin-bottom: 2px; }
        .icon-dot { background-color: var(--text-light); border-radius: 50%; opacity: 0.5; }
        .tab-btn.active .icon-dot { background-color: var(--primary); opacity: 1; }

        .drill-list { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px; }
        .hidden { display: none !important; }
        
        .btn-drill { background: var(--surface); border: 1px solid transparent; border-radius: 20px; padding: 15px 8px; font-size: 0.8rem; font-weight: 600; color: var(--btn-text); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 2px 5px var(--shadow); transition: all 0.1s; min-height: 85px; width: 100%; position: relative; user-select: none; -webkit-user-select: none; }
        .btn-drill span { text-align: center; line-height: 1.3; width: 100%; }
        .btn-drill:active { transform: scale(0.97); }
        .btn-drill.running { border-color: var(--primary); background: var(--primary-dim); color: var(--primary); }
        .btn-drill:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; background: rgba(0,0,0,0.05); }
        [data-theme="night"] .btn-drill:disabled { background: rgba(255,255,255,0.05); }
        
        .btn-drill .drill-icon { display: grid; grid-template-columns: 1fr 1fr; gap: 3px; width: 14px; height: 14px; }
        .btn-drill .drill-icon .d-dot { background-color: #b2bec3; border-radius: 50%; transition: background-color var(--trans-speed); }
        .btn-drill.running .drill-icon .d-dot { background-color: var(--primary); }
        
        /* RANDOM MARK */
        .mark-random { position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; border: 2px solid var(--danger); color: var(--danger); border-radius: 50%; font-size: 10px; font-weight: 900; display: flex; align-items: center; justify-content: center; background: transparent; line-height: 1; pointer-events: none; }

        #status-text { text-align: center; font-size: 0.8rem; color: var(--primary); font-weight: 700; height: 20px; margin-bottom: 5px; letter-spacing: 0.5px; text-transform: uppercase; }
        .log-box { margin-top: 10px; background: #2d3436; color: #00cec9; padding: 12px; border-radius: 10px; font-family: monospace; font-size: 0.65rem; height: 120px; overflow-y: auto; display: none; border: 1px solid #636e72; line-height: 1.4; }
        .log-box div { margin-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px; }
        
        /* FOOTER CONTROLS */
        .footer-row { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; font-size: 0.8rem; color: var(--text-light); font-weight: 600; padding: 0 5px; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 6px; }
        #stats-display { font-variant-numeric: tabular-nums; }

        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 200; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 0.9rem; opacity: 0; transition: opacity 0.5s, bottom 0.5s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal { background: var(--surface); width: 95%; max-width: 400px; max-height: 90vh; border-radius: 25px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.4); display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .modal-title { font-weight: 700; color: var(--text); font-size: 1.1rem; }
        .modal-close { font-size: 1.5rem; color: var(--text-light); cursor: pointer; line-height: 1; }
        .modal-body { overflow-y: auto; flex: 1; padding-right: 5px; }
        
        .ball-editor { background: var(--bg); padding: 10px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border); }
        .ball-title { font-size: 0.75rem; font-weight: 700; color: var(--primary); margin-bottom: 8px; text-transform: uppercase; }
        .editor-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
        .editor-field { display: flex; flex-direction: column; }
        .field-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 2px; }
        .field-header label { font-size: 0.6rem; color: var(--text-light); font-weight: 700; }
        .field-header .range-hint { font-size: 0.55rem; color: #b2bec3; font-weight: 400; }
        .editor-field input { background: var(--surface); border: 1px solid var(--border); padding: 6px 2px; border-radius: 8px; font-size: 0.85rem; color: var(--text); font-weight: 700; text-align: center; -moz-appearance: textfield; width: 100%; box-sizing: border-box; min-width: 0; }
        .modal-footer { margin-top: 15px; display: flex; gap: 10px; }
        .btn-modal { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .btn-save { background: var(--primary); color: white; }
        .btn-cancel { background: var(--card-bg); color: var(--text); }

        /* --- RUN OVERLAY --- */
        #run-ui { display: none; flex-direction: column; align-items: center; width: 100%; justify-content: center; text-align: center; }
        .modal-overlay.open #run-ui { display: flex; }

        .countdown-circle { position: relative; width: 200px; height: 200px; margin-bottom: 30px; }
        .countdown-circle svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .track { fill: none; stroke: var(--ring-track); stroke-width: 8; }
        .progress { fill: none; stroke: var(--primary); stroke-width: 8; stroke-dasharray: 565; stroke-dashoffset: 0; stroke-linecap: round; }
        
        .center-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .count-val { font-size: 4.5rem; font-weight: 800; color: var(--text); line-height: 1; font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        .status-label { font-size: 0.9rem; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        .run-controls { display: flex; flex-direction: column; gap: 15px; width: 100%; margin-top: 10px; }
        .btn-run-ctrl { width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-run-ctrl:active { transform: scale(0.95); }
        .btn-pause { background: var(--card-bg); color: var(--text); }
        .btn-stop-run { background: var(--danger); color: white; }
        .pulse-anim { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    
    <header>
        <h1>Nova Drill Control</h1>
        <div class="menu-btn" onclick="toggleMenu()">
            <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </div>
    </header>

    <div id="theme-menu" class="theme-menu">
        <div class="menu-title">Custom Data</div>
        <div class="theme-item" onclick="document.getElementById('csv-input').click()"><span class="color-preview" style="background:var(--text)"></span> Import Custom Drills</div>
        <div class="theme-item" onclick="exportCustomDrills()"><span class="color-preview" style="background:var(--text)"></span> Export Custom Drills</div>
        <div class="theme-item" onclick="saveAsDefault()"><span class="color-preview" style="background:var(--primary)"></span> Save Defaults</div>
        <div class="theme-item" onclick="resetToDefault()">Reset Defaults</div>
        <div class="theme-item" onclick="resetStats()">Reset Statistics</div>
        
        <div style="border-top: 1px solid var(--border); margin: 5px 0;"></div>
        <div class="menu-title">Theme</div>
        <div class="theme-item" onclick="setTheme('standard')"><span class="color-preview" style="background:#ff6b4a"></span> Standard</div>
        <div class="theme-item" onclick="setTheme('ocean')"><span class="color-preview" style="background:#0984e3"></span> Ocean</div>
        <div class="theme-item" onclick="setTheme('forest')"><span class="color-preview" style="background:#00b894"></span> Forest</div>
        <div class="theme-item" onclick="setTheme('night')"><span class="color-preview" style="background:#2d3436"></span> Dark</div>
        
        <div style="border-top: 1px solid var(--border); margin: 5px 0;"></div>
        <div class="theme-item reset-item" onclick="factoryReset()">Factory Reset</div>
    </div>
    <input type="file" id="csv-input" accept=".csv" style="display:none" onchange="handleCSVUpload(event)">

    <div class="settings-card">
        <div id="status-text">Disconnected</div>
        <button id="btn-connect" class="btn-connect">Connect</button>

        <div class="control-group" id="grp-difficulty">
            <div style="text-align:center; font-size:0.65rem; color:var(--text-light); margin-bottom:5px; font-weight:700;">DIFFICULTY LEVEL</div>
            <div class="level-select">
                <div class="lvl-dot active" onclick="setLevel(1, this)">1</div>
                <div class="lvl-dot" onclick="setLevel(2, this)">2</div>
                <div class="lvl-dot" onclick="setLevel(3, this)">3</div>
            </div>
        </div>

        <div class="control-pill" style="margin-bottom: 10px; box-shadow:none; background:transparent; padding:0;">
            <div class="mode-switch">
                <div class="mode-option active" onclick="setMode('reps', this)">Reps</div>
                <div class="mode-option" onclick="setMode('time', this)">Time</div>
            </div>
        </div>

        <div class="controls-row">
            <div class="control-pill" id="ui-reps">
                <label>Count</label>
                <input type="number" id="input-reps" value="10">
            </div>
            <div class="control-pill hidden" id="ui-time">
                <label>Time (s)</label>
                <input type="number" id="input-time" value="60" step="10">
            </div>
            <div class="control-pill">
                <label>Pause (ms)</label>
                <input type="number" id="input-pause" value="1000" step="100">
            </div>
        </div>
    </div>

    <div class="section-label">Drill Selection</div>
    
    <div class="tabs-container">
        <div class="tab-btn active" onclick="switchTab('basic', this)">
            <div class="icon-grid"><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div></div> Basic
        </div>
        <div class="tab-btn" onclick="switchTab('combined', this)">
            <div class="icon-grid"><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div></div> Combined
        </div>
        <div class="tab-btn" onclick="switchTab('complex', this)">
            <div class="icon-grid"><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div></div> Complex
        </div>
        <div class="tab-btn" onclick="switchTab('custom-a', this)">
            <div class="icon-grid"><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div></div> Custom A
        </div>
        <div class="tab-btn" onclick="switchTab('custom-b', this)">
            <div class="icon-grid"><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div></div> Custom B
        </div>
        <div class="tab-btn" onclick="switchTab('custom-c', this)">
            <div class="icon-grid"><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div><div class="icon-dot"></div></div> Custom C
        </div>
    </div>

    <div id="view-basic" class="drill-list"></div>
    <div id="view-combined" class="drill-list hidden"></div>
    <div id="view-complex" class="drill-list hidden"></div>
    <div id="view-custom-a" class="drill-list hidden"></div>
    <div id="view-custom-b" class="drill-list hidden"></div>
    <div id="view-custom-c" class="drill-list hidden"></div>

    <div class="footer-row">
        <div id="stats-display">Balls: 0 | Drills: 0</div>
        <div class="checkbox-wrapper">
            <input type="checkbox" id="chk-console"> 
            <label for="chk-console" style="margin:0; cursor:pointer;">Show Log</label>
        </div>
    </div>
    
    <div id="log" class="log-box"></div>
</div>

<div id="toast">Notification</div>

<div id="editor-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Edit Drill</div>
            <div style="display:flex; align-items:center; gap:5px; margin-left:auto; margin-right:20px;">
                <input type="checkbox" id="chk-drill-random">
                <label for="chk-drill-random" style="font-size:0.75rem; font-weight:600; color:var(--text-light);">Random</label>
            </div>
            <div class="modal-close" onclick="closeEditor()">Ã—</div>
        </div>
        <div id="editor-body" class="modal-body"></div>
        <div class="modal-footer">
            <button class="btn-modal btn-cancel" onclick="closeEditor()">Cancel</button>
            <button class="btn-modal btn-save" onclick="saveDrillChanges()">Save</button>
        </div>
    </div>
</div>

<div id="run-overlay" class="modal-overlay">
    <div class="modal" style="background: var(--surface); width: 90%; max-width:450px; padding: 30px 20px;">
        <div id="run-ui">
            <div class="countdown-circle">
                <svg viewBox="0 0 200 200">
                    <circle class="track" cx="100" cy="100" r="90"></circle>
                    <circle class="progress" id="run-progress" cx="100" cy="100" r="90"></circle>
                </svg>
                <div class="center-text">
                    <div class="count-val" id="run-display">4</div>
                    <div class="status-label" id="run-label">GET READY</div>
                </div>
            </div>

            <div class="run-controls">
                <button id="btn-pause" class="btn-run-ctrl btn-pause" onclick="togglePause()">PAUSE</button>
                <button class="btn-run-ctrl btn-stop-run" onclick="stopRun()">STOP</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. Global Helpers ---
    const ui = {
        connect: document.getElementById('btn-connect'),
        statusText: document.getElementById('status-text'),
        log: document.getElementById('log'),
        inputPause: document.getElementById('input-pause'),
        themeMenu: document.getElementById('theme-menu'),
        runOverlay: document.getElementById('run-overlay'),
        runDisplay: document.getElementById('run-display'),
        runLabel: document.getElementById('run-label'),
        runProgress: document.getElementById('run-progress'),
        btnPause: document.getElementById('btn-pause'),
        statsDisplay: document.getElementById('stats-display')
    };

    function log(msg) {
        const t = new Date().toLocaleTimeString().split(' ')[0];
        const line = document.createElement('div');
        line.textContent = `[${t}] ${msg}`;
        if (ui.log) {
            ui.log.appendChild(line);
            ui.log.scrollTop = ui.log.scrollHeight;
        }
        console.log(`[${t}] ${msg}`);
    }

    function showToast(text) {
        const t = document.getElementById('toast');
        t.textContent = text;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }

    // --- 2. Data & Constants ---
    const SERVICE = 0xfeff;
    const UUID_S = "02f00000-0000-0000-0000-00000000fe00";
    const UUID_N = "02f00000-0000-0000-0000-00000000ff02";
    const UUID_W = "02f00000-0000-0000-0000-00000000ff01";
    const SALT = "Mjgx1jAwXDBaMFcxCz3JBgNVBAYT4kJF7Rkw";
    const MSG_DONE = "00020300050100";

    const DEFAULT_DRILLS = {
        "push(b)": { 1: [[1547, 2915, 50, -5, 0, 1]], 2: [[1205, 3257, 50, -5, 10, 1]], 3: [[863, 3599, 50, -5, 10, 1]] },
        "push(f)": { 1: [[1547, 2915, 50, 5, 0, 1]], 2: [[1205, 3257, 50, 5, 10, 1]], 3: [[863, 3599, 50, 5, 10, 1]] },
        "drive(b)": { 1: [[3545, 2177, 60, -5, 20, 1]], 2: [[3545, 2177, 50, -5, 40, 1]], 3: [[3545, 2177, 50, -5, 70, 1]] },
        "drive(f)": { 1: [[3545, 2177, 50, 1, 20, 1]], 2: [[3545, 2177, 50, 0, 40, 1]], 3: [[3545, 2177, 50, 5, 70, 1]] },
        "loop(f)": { 1: [[1520, 3572, 50, 5, 0, 1]], 2: [[1178, 3914, 50, 5, 10, 1]], 3: [[836, 4256, 50, 5, 10, 1]] },
        "loop(b)": { 1: [[1520, 3572, 50, -5, 0, 1]], 2: [[1178, 3914, 50, -5, 10, 1]], 3: [[836, 4256, 50, -5, 10, 1]] },

        "loop(b)-drive(b)": { 1: [[1520, 3572, 50, -5, 0, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[836, 4256, 50, -5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "loop(f)-drive(f)": { 1: [[1520, 3572, 50, 5, 0, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[836, 4256, 50, 5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "drive(f)-drive(b)": { 1: [[3545, 2177, 50, 5, 30, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[3545, 2177, 50, 5, 60, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[3545, 2177, 50, 5, 80, 1], [3545, 2177, 50, -5, 80, 1]] },
        "push(f)-drive(f)": { 1: [[1547, 2915, 50, 5, 0, 1], [3545, 2177, 50, 0, 30, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [3545, 2177, 50, 0, 60, 1]], 3: [[863, 3599, 50, 5, 10, 1], [3545, 2177, 50, 0, 80, 1]] },
        "push(b)-loop(b)": { 1: [[1547, 2915, 50, -5, 10, 1], [1520, 3572, 50, -5, 10, 1]], 2: [[1205, 3257, 50, -5, 10, 1], [1178, 3914, 50, -5, 20, 1]], 3: [[863, 3599, 50, -5, 10, 1], [836, 4256, 50, -5, 20, 1]] },
        "loop(f)-drive(b)": { 1: [[1520, 3572, 50, 5, 0, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[836, 4256, 50, 5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "push(f)-loop(b)": { 1: [[1547, 2915, 50, 5, 10, 1], [1520, 3572, 50, -5, 10, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [1178, 3914, 50, -5, 20, 1]], 3: [[863, 3599, 50, 5, 10, 1], [836, 4256, 50, -5, 20, 1]] },
        "drive(f)-drive(f)": { 1: [[3545, 2177, 50, 2, 30, 1], [3545, 2177, 50, -3, 30, 1]], 2: [[3545, 2177, 50, 5, 60, 1], [3545, 2177, 50, 0, 60, 1]], 3: [[3545, 2177, 50, 5, 80, 1], [3545, 2177, 50, 0, 80, 1]] },
        "push(b)-loop(f)": { 1: [[1547, 2915, 50, -5, 10, 1], [1520, 3572, 50, 5, 10, 1]], 2: [[1205, 3257, 50, -5, 10, 1], [1178, 3914, 50, 5, 20, 1]], 3: [[863, 3599, 50, -5, 10, 1], [836, 4256, 50, 5, 20, 1]] },
        "push(f)-loop(f)": { 1: [[1547, 2915, 44, 5, 10, 1], [1520, 3572, 44, 5, 10, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [1178, 3914, 50, 5, 20, 1]], 3: [[863, 3599, 50, 5, 10, 1], [836, 4256, 50, 5, 20, 1]] },
        "loop(f)-loop(f)": { 1: [[1520, 3572, 50, 5, 0, 1], [1520, 3572, 50, 0, 0, 1]], 2: [[1178, 3914, 50, 5, 10, 1], [1178, 3914, 50, 0, 10, 1]], 3: [[836, 4256, 50, 5, 10, 1], [836, 4256, 50, 0, 10, 1]] },
        "loop(b)-drive(f)": { 1: [[1520, 3572, 50, -5, 0, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[836, 4256, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },

        "push(b)-loop(f)-drive(b)": { 1: [[1547, 2915, 50, -5, 0, 1], [1520, 3572, 50, 5, 10, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1205, 3257, 50, -5, 10, 1], [1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[863, 3599, 50, -5, 10, 1], [836, 4256, 50, 5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "push(f)-loop(b)-drive(f)": { 1: [[1547, 2915, 50, 5, 0, 1], [1520, 3572, 50, -5, 10, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[863, 3599, 50, 5, 10, 1], [836, 4256, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "loop(f)-drive(f)-drive(b)": { 1: [[1520, 3572, 50, 5, 0, 1], [3545, 2177, 50, 5, 10, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, 5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[836, 4256, 50, 5, 10, 1], [3545, 2177, 50, 5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "loop(b)-drive(f)-drive(b)": { 1: [[1520, 3572, 50, -5, 0, 1], [3545, 2177, 50, 5, 10, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, 5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[836, 4256, 50, -5, 10, 1], [3545, 2177, 50, 5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "drive(f)-drive(f)-drive(f)": { 1: [[3545, 2177, 50, 5, 30, 1], [3545, 2177, 50, 0, 30, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[3545, 2177, 50, 5, 60, 1], [3545, 2177, 50, 0, 60, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[3545, 2177, 50, 5, 80, 1], [3545, 2177, 50, 0, 80, 1], [3545, 2177, 50, -5, 80, 1]] },
        "push(f)-loop(f)-drive(f)": { 1: [[1547, 2915, 50, 5, 0, 1], [1520, 3572, 50, 5, 10, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[863, 3599, 50, 5, 10, 1], [836, 4256, 50, 5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "push(b)-loop(b)-drive(b)": { 1: [[1547, 2915, 50, -5, 0, 1], [1520, 3572, 50, -5, 10, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1205, 3257, 50, -5, 10, 1], [1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[863, 3599, 50, -5, 10, 1], [836, 4256, 50, -5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "push(f)-loop(b)-drive(b)": { 1: [[1547, 2915, 50, 5, 0, 1], [1520, 3572, 50, -5, 10, 1], [3545, 2177, 50, -5, 30, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[863, 3599, 50, 5, 10, 1], [836, 4256, 50, -5, 10, 1], [3545, 2177, 50, -5, 80, 1]] },
        "loop(f)-drive(b)-drive(f)": { 1: [[1520, 3572, 50, 5, 0, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[836, 4256, 50, 5, 10, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "loop(b)-drive(b)-drive(f)": { 1: [[1520, 3572, 48, -5, 0, 1], [3545, 2177, 48, -5, 10, 1], [3545, 2177, 48, 5, 30, 1]], 2: [[1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[836, 4256, 50, -5, 10, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "push(b)-loop(f)-drive(f)": { 1: [[1547, 2915, 50, -5, 0, 1], [1520, 3572, 50, 5, 10, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1205, 3257, 50, -5, 10, 1], [1178, 3914, 50, 5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[863, 3599, 50, -5, 10, 1], [836, 4256, 50, 5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "push(b)-loop(b)-drive(f)": { 1: [[1547, 2915, 50, -5, 0, 1], [1520, 3572, 50, -5, 10, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[1205, 3257, 50, -5, 10, 1], [1178, 3914, 50, -5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[863, 3599, 50, -5, 10, 1], [836, 4256, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "drive(b)-drive(f)-drive(f)": { 1: [[3545, 2177, 50, -5, 0, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 30, 1]], 2: [[3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 60, 1]], 3: [[3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1]] },
        "random-drive": { 1: [[3545, 2177, 46, 5, 30, 1], [3545, 2177, 46, 0, 30, 1], [3545, 2177, 46, -5, 30, 1]], 2: [[3545, 2177, 50, 5, 60, 1], [3545, 2177, 50, 0, 60, 1], [3545, 2177, 50, -5, 60, 1]], 3: [[3545, 2177, 50, 5, 80, 1], [3545, 2177, 50, 0, 80, 1], [3545, 2177, 50, -5, 80, 1]] },
        "23-random-drive": { 1: [[3545, 2177, 50, 5, 30, 1], [3545, 2177, 50, 3, 30, 1], [3545, 2177, 50, 1, 30, 1], [3545, 2177, 50, -1, 30, 1]], 2: [[3545, 2177, 50, 5, 60, 1], [3545, 2177, 50, 3, 60, 1], [3545, 2177, 50, 1, 60, 1], [3545, 2177, 50, -1, 60, 1]], 3: [[3545, 2177, 50, 5, 80, 1], [3545, 2177, 50, 3, 80, 1], [3545, 2177, 50, 1, 80, 1], [3545, 2177, 50, -1, 80, 1]] },
        "all-random": { 1: [[1547, 2915, 50, 5, 10, 1], [1547, 2915, 50, -5, 10, 1], [3545, 2177, 50, 5, 40, 1], [3545, 2177, 50, 0, 40, 1], [3545, 2177, 50, -5, 40, 1]], 2: [[1205, 3257, 50, 5, 10, 1], [1205, 3257, 50, -5, 10, 1], [3545, 2177, 50, 5, 50, 1], [3545, 2177, 50, 0, 50, 1], [3545, 2177, 50, -5, 50, 1]], 3: [[863, 3599, 50, 5, 10, 1], [863, 3599, 50, -5, 10, 1], [3545, 2177, 50, 5, 80, 1], [3545, 2177, 50, 0, 80, 1], [3545, 2177, 50, -5, 80, 1]] }
    };

    const CATEGORIES = {
        basic: ["push(b)", "push(f)", "drive(b)", "drive(f)", "loop(b)", "loop(f)"],
        combined: ["loop(b)-drive(b)", "loop(f)-drive(f)", "drive(f)-drive(b)", "push(f)-drive(f)", "push(b)-loop(b)", "loop(f)-drive(b)", "push(f)-loop(b)", "drive(f)-drive(f)", "push(b)-loop(f)", "push(f)-loop(f)", "loop(f)-loop(f)", "loop(b)-drive(f)"],
        complex: ["push(b)-loop(f)-drive(b)", "push(f)-loop(b)-drive(f)", "loop(f)-drive(f)-drive(b)", "loop(b)-drive(f)-drive(b)", "drive(f)-drive(f)-drive(f)", "push(f)-loop(f)-drive(f)", "push(b)-loop(b)-drive(b)", "push(f)-loop(b)-drive(b)", "loop(f)-drive(b)-drive(f)", "loop(b)-drive(b)-drive(f)", "push(b)-loop(f)-drive(f)", "push(b)-loop(b)-drive(f)", "drive(b)-drive(f)-drive(f)", "random-drive", "23-random-drive", "all-random"],
        "custom-a": [], "custom-b": [], "custom-c": [] 
    };

    // --- 3. State ---
    let device, notifyChar, writeChar;
    let writeLock = Promise.resolve();
    let state = "disconnected";
    let isRunning = false;
    let isPaused = false;
    let currentCount = 0;
    let targetCount = 0;
    let pauseTimer = null;
    let countdownTimer = null;
    let runTimer = null;
    let activeDrillParams = null;
    let activeDrillRandom = false; 
    let runMode = "reps"; 
    let endTime = 0;
    let remainingTime = 0;
    let selectedLevel = 1;
    let appStats = { balls: 0, drills: 0 };
    
    // Safely load storage with fallback to prevent crashes if storage is corrupt
    let savedDrills = null;
    try { savedDrills = localStorage.getItem('custom_drills'); } catch(e) { console.error(e); }
    
    let userDefaults = null;
    try { userDefaults = localStorage.getItem('user_defaults'); } catch(e) { console.error(e); }
    
    let customData = null;
    try { customData = localStorage.getItem('custom_data'); } catch(e) { console.error(e); }
    
    let currentDrills = savedDrills ? JSON.parse(savedDrills) : 
                       (userDefaults ? JSON.parse(userDefaults) : JSON.parse(JSON.stringify(DEFAULT_DRILLS)));
    
    let userCustomDrills = customData ? JSON.parse(customData) : { "custom-a": [], "custom-b": [], "custom-c": [] };

    let editingDrillKey = null;
    let pressTimer = null;
    let longPressHandled = false;

    // --- 4. Initialization ---
    // Ensure this runs after all definitions
    init();

    function init() {
        // Load saved theme
        const savedTheme = localStorage.getItem('nova_theme_pref');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
        }
        
        // Load Stats
        const savedStats = localStorage.getItem('nova_stats');
        if (savedStats) {
            try { appStats = JSON.parse(savedStats); } catch(e){}
        }
        updateStatsUI();

        renderDrillButtons();
        updateDrillButtonStates(); 
        log("System Ready.");
    }

    function setTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        localStorage.setItem('nova_theme_pref', themeName);
        ui.themeMenu.classList.remove('open');
    }

    function updateStatsUI() {
        if(ui.statsDisplay) {
            ui.statsDisplay.textContent = `Balls: ${appStats.balls} | Drills: ${appStats.drills}`;
        }
    }

    function resetStats() {
        if(confirm("Reset total ball and drill counts to zero?")) {
            appStats = { balls: 0, drills: 0 };
            localStorage.setItem('nova_stats', JSON.stringify(appStats));
            updateStatsUI();
            ui.themeMenu.classList.remove('open');
            showToast("Statistics Reset");
        }
    }

    function renderDrillButtons() {
        try {
            ['basic', 'combined', 'complex'].forEach(cat => {
                const container = document.getElementById(`view-${cat}`);
                if (!container) return;
                container.innerHTML = '';
                
                CATEGORIES[cat].forEach(key => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-drill';
                    btn.dataset.key = key;
                    
                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'drill-icon';
                    for(let i=0; i<4; i++) {
                        const d = document.createElement('div');
                        d.className = 'd-dot';
                        iconDiv.appendChild(d);
                    }
                    
                    btn.appendChild(iconDiv);

                    // Add Random Mark if applicable
                    if (currentDrills[key] && currentDrills[key].random) {
                        const rMark = document.createElement('div');
                        rMark.className = 'mark-random';
                        rMark.textContent = 'R';
                        btn.appendChild(rMark);
                    }
                    
                    const span = document.createElement('span');
                    span.textContent = formatDrillName(key);
                    btn.appendChild(span);
                    
                    btn.addEventListener('click', () => handleDrillClick(key, btn));
                    
                    const startPress = (e) => handlePressStart(e, key);
                    const endPress = (e) => handlePressEnd(e);
                    
                    btn.addEventListener('mousedown', startPress);
                    btn.addEventListener('touchstart', startPress, {passive: true});
                    btn.addEventListener('mouseup', endPress);
                    btn.addEventListener('mouseleave', endPress);
                    btn.addEventListener('touchend', endPress);
                    
                    container.appendChild(btn);
                });
            });

            ['custom-a', 'custom-b', 'custom-c'].forEach(cat => {
                const container = document.getElementById(`view-${cat}`);
                if (!container) return;
                container.innerHTML = '';
                if (userCustomDrills[cat].length === 0) {
                    container.innerHTML = '<div style="grid-column:span 2; text-align:center; color:#999; padding:20px; font-size:0.8rem;">No drills imported.<br>Use Settings > Import CSV</div>';
                } else {
                    userCustomDrills[cat].forEach(item => {
                        createCustomButton(container, item.key, item.name);
                    });
                }
            });
        } catch(e) {
            log("Render Error: " + e.message);
        }
    }

    function createCustomButton(container, key, label) {
        const btn = document.createElement('button');
        btn.className = 'btn-drill';
        btn.dataset.key = key;
        
        const iconDiv = document.createElement('div');
        iconDiv.className = 'drill-icon';
        for(let i=0; i<4; i++) {
            const d = document.createElement('div');
            d.className = 'd-dot';
            iconDiv.appendChild(d);
        }
        btn.appendChild(iconDiv);
        
        if (currentDrills[key] && currentDrills[key].random) {
            const rMark = document.createElement('div');
            rMark.className = 'mark-random';
            rMark.textContent = 'R';
            btn.appendChild(rMark);
        }

        const span = document.createElement('span');
        span.textContent = label;
        btn.appendChild(span);
        
        btn.addEventListener('click', () => handleDrillClick(key, btn));
        
        const startPress = (e) => handlePressStart(e, key);
        const endPress = (e) => handlePressEnd(e);
        
        btn.addEventListener('mousedown', startPress);
        btn.addEventListener('touchstart', startPress, {passive: true});
        btn.addEventListener('mouseup', endPress);
        btn.addEventListener('mouseleave', endPress);
        btn.addEventListener('touchend', endPress);
        
        container.appendChild(btn);
    }

    function updateDrillButtonStates() {
        const btns = document.querySelectorAll('.btn-drill');
        btns.forEach(b => {
             if (state !== 'ready') {
                 b.style.opacity = "0.6"; 
             } else {
                 b.style.opacity = "1";
             }
        });
    }

    function formatDrillName(key) {
        if (key.startsWith('cust_')) return key; 
        return key.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    // --- 5. Interaction Handlers ---
    
    function handleDrillClick(key, btn) {
        if (longPressHandled) {
            longPressHandled = false;
            return;
        }
        
        if (state !== 'ready') {
            showToast("Device not connected");
            return;
        }

        document.querySelectorAll('.btn-drill').forEach(b => b.classList.remove('running'));
        btn.classList.add('running');
        startDrillSequence(key);
    }

    function handlePressStart(e, key) {
        if (isRunning) return;
        longPressHandled = false;
        pressTimer = setTimeout(() => {
            longPressHandled = true;
            openEditor(key);
        }, 600); 
    }

    function handlePressEnd(e) {
        clearTimeout(pressTimer);
    }

    // --- 6. Editor, CSV & Settings ---
    const RANGE_CONFIG = [
        { label: 'Top', class: 'inp-us', min: 400, max: 7500, step: 1, idx: 0 },
        { label: 'Bot', class: 'inp-ls', min: 400, max: 7500, step: 1, idx: 1 },
        { label: 'Hgt', class: 'inp-bh', min: -50, max: 100, step: 1, idx: 2 },
        { label: 'Drp', class: 'inp-dp', min: -10, max: 10, step: 0.5, idx: 3 },
        { label: 'Frq', class: 'inp-fr', min: 0, max: 100, step: 10, idx: 4 },
        { label: 'Rep', class: 'inp-rp', min: 1, max: 200, step: 1, idx: 5 }
    ];

    function openEditor(key) {
        editingDrillKey = key;
        const levelData = currentDrills[key][selectedLevel];
        
        const chk = document.getElementById('chk-drill-random');
        chk.checked = !!currentDrills[key].random;

        const modalBody = document.getElementById('editor-body');
        modalBody.innerHTML = '';

        levelData.forEach((ballParams, index) => {
            const div = document.createElement('div');
            div.className = 'ball-editor';
            
            let gridHtml = '<div class="editor-grid">';
            RANGE_CONFIG.forEach(cfg => {
                gridHtml += `
                    <div class="editor-field">
                        <div class="field-header">
                            <label>${cfg.label}</label>
                            <span class="range-hint">${cfg.min}-${cfg.max}</span>
                        </div>
                        <input type="number" class="${cfg.class}" value="${ballParams[cfg.idx]}" min="${cfg.min}" max="${cfg.max}" step="${cfg.step}">
                    </div>
                `;
            });
            gridHtml += '</div>';

            div.innerHTML = `<div class="ball-title">Ball ${index + 1}</div>` + gridHtml;
            modalBody.appendChild(div);
        });
        document.getElementById('editor-modal').classList.add('open');
    }

    function closeEditor() {
        document.getElementById('editor-modal').classList.remove('open');
        editingDrillKey = null;
    }
    
    function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

    function saveDrillChanges() {
        if (!editingDrillKey) return;
        
        currentDrills[editingDrillKey].random = document.getElementById('chk-drill-random').checked;
        
        const modalBody = document.getElementById('editor-body');
        const ballDivs = modalBody.getElementsByClassName('ball-editor');
        const newSequence = [];

        for (let div of ballDivs) {
            const us = clamp(parseInt(div.querySelector('.inp-us').value), 400, 7500);
            const ls = clamp(parseInt(div.querySelector('.inp-ls').value), 400, 7500);
            const bh = clamp(parseInt(div.querySelector('.inp-bh').value), -50, 100);
            const dp = clamp(parseFloat(div.querySelector('.inp-dp').value), -10, 10);
            const fr = clamp(parseInt(div.querySelector('.inp-fr').value), 0, 100);
            const rp = clamp(parseInt(div.querySelector('.inp-rp').value), 1, 200);
            newSequence.push([us, ls, bh, dp, fr, rp]);
        }
        currentDrills[editingDrillKey][selectedLevel] = newSequence;
        localStorage.setItem('custom_drills', JSON.stringify(currentDrills));
        
        renderDrillButtons();
        closeEditor();
        showToast(`Saved Level ${selectedLevel}`);
    }

    function handleCSVUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) { parseCSV(e.target.result); };
        reader.readAsText(file);
        event.target.value = '';
    }

    function parseCSV(text) {
        const lines = text.split(/\r?\n/);
        const newCustomData = { "custom-a": [], "custom-b": [], "custom-c": [] };
        const newDrillParams = {};

        for (let cat in userCustomDrills) {
            userCustomDrills[cat].forEach(drill => {
                if (currentDrills[drill.key]) delete currentDrills[drill.key];
            });
        }

        const getCat = (val) => {
            val = val.trim().toUpperCase();
            if(val === 'A') return 'custom-a';
            if(val === 'B') return 'custom-b';
            if(val === 'C') return 'custom-c';
            return null;
        };

        lines.forEach(line => {
            if (!line.trim()) return;
            const sep = line.includes(';') ? ';' : ',';
            const parts = line.split(sep);
            if (parts.length < 8) return;
            if (isNaN(parseInt(parts[2]))) return;

            const catCode = parts[0].trim();
            const name = parts[1].trim().substring(0, 32);
            const category = getCat(catCode);

            if (!category) return;

            const ball = [
                parseInt(parts[2]), parseInt(parts[3]), parseInt(parts[4]),
                parseFloat(parts[5]), parseInt(parts[6]), parseInt(parts[7])
            ];

            const key = `cust_${catCode}_${name.replace(/\s+/g, '_')}`;

            if (!newDrillParams[key]) {
                let exists = newCustomData[category].find(d => d.key === key);
                if (!exists) {
                    if (newCustomData[category].length >= 20) return;
                    newCustomData[category].push({ name: name, key: key });
                    newDrillParams[key] = { 1: [], 2: [], 3: [] };
                }
            }

            if (newDrillParams[key][1].length < 20) {
                newDrillParams[key][1].push(ball);
                newDrillParams[key][2].push(ball);
                newDrillParams[key][3].push(ball);
            }
        });

        userCustomDrills = newCustomData;
        Object.assign(currentDrills, newDrillParams);
        localStorage.setItem('custom_data', JSON.stringify(userCustomDrills));
        localStorage.setItem('custom_drills', JSON.stringify(currentDrills));
        renderDrillButtons();
        ui.themeMenu.classList.remove('open');
        showToast("Imported");
    }

    function exportCustomDrills() {
        let csvContent = "Set,Name,Top,Bottom,Height,Drop,Freq,Reps\n";
        const cats = { 'custom-a': 'A', 'custom-b': 'B', 'custom-c': 'C' };
        for (let catKey in cats) {
            const setLabel = cats[catKey];
            const drillList = userCustomDrills[catKey];
            if(drillList && drillList.length > 0) {
                drillList.forEach(drill => {
                    const sequence = currentDrills[drill.key] ? currentDrills[drill.key][1] : null; 
                    if (sequence) {
                        sequence.forEach(ball => {
                             const row = [setLabel, drill.name, ball[0], ball[1], ball[2], ball[3], ball[4], ball[5]].join(",");
                             csvContent += row + "\n";
                        });
                    }
                });
            }
        }
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "nova_custom_drills.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        ui.themeMenu.classList.remove('open');
    }
    
    function saveAsDefault() {
        if(confirm("Save current settings as your new personal default?")) {
            localStorage.setItem('user_defaults', JSON.stringify(currentDrills));
            toggleMenu();
            showToast("Saved as Default");
        }
    }

    function resetToDefault() {
        const hasUserDefault = localStorage.getItem('user_defaults');
        if(confirm(hasUserDefault ? "Restore saved defaults?" : "Restore factory settings?")) {
            currentDrills = hasUserDefault ? JSON.parse(hasUserDefault) : JSON.parse(JSON.stringify(DEFAULT_DRILLS));
            localStorage.setItem('custom_drills', JSON.stringify(currentDrills));
            toggleMenu();
            showToast("Restored");
        }
    }

    function factoryReset() {
        if(confirm("WARNING: Delete ALL saved data (including custom drills) and return to original factory state?")) {
            localStorage.clear(); 
            // Re-apply standard theme visually before reload
            document.documentElement.setAttribute('data-theme', 'standard');
            // Reload page to clear memory state and re-initialize from defaults
            location.reload();
        }
    }

    // --- 7. UI Logic ---
    function toggleMenu() { ui.themeMenu.classList.toggle('open'); }
    document.addEventListener('click', (e) => {
        if (!ui.themeMenu.contains(e.target) && !e.target.closest('.menu-btn')) {
            ui.themeMenu.classList.remove('open');
        }
    });

    function setTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        localStorage.setItem('nova_theme_pref', themeName);
        ui.themeMenu.classList.remove('open');
    }

    function switchTab(catName, btn) {
        ['basic','combined','complex','custom-a','custom-b','custom-c'].forEach(c => {
            const el = document.getElementById('view-'+c);
            if(el) el.classList.add('hidden');
        });
        document.getElementById('view-' + catName).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');

        // Logic to hide/show Difficulty Level
        const diffGroup = document.getElementById('grp-difficulty');
        if(diffGroup) {
            if (['custom-a', 'custom-b', 'custom-c'].includes(catName)) {
                diffGroup.style.display = 'none';
            } else {
                diffGroup.style.display = 'flex';
            }
        }
    }

    function setLevel(lvl, btn) {
        selectedLevel = lvl;
        document.querySelectorAll('.lvl-dot').forEach(d => d.classList.remove('active'));
        btn.classList.add('active');
    }

    function setMode(mode, btn) {
        runMode = mode;
        document.querySelectorAll('.mode-option').forEach(d => d.classList.remove('active'));
        btn.classList.add('active');
        if(mode === 'reps') {
            document.getElementById('ui-reps').classList.remove('hidden');
            document.getElementById('ui-time').classList.add('hidden');
        } else {
            document.getElementById('ui-reps').classList.add('hidden');
            document.getElementById('ui-time').classList.remove('hidden');
        }
    }

    ui.inputPause.onchange = (e) => {
        let val = parseInt(e.target.value);
        if(val < 500) val = 500;
        if(val > 5000) val = 5000;
        ui.inputPause.value = val;
    };

    document.getElementById('chk-console').onchange = (e) => {
        ui.log.style.display = e.target.checked ? 'block' : 'none';
    };

    ui.connect.onclick = () => {
        if (device && device.gatt.connected) device.gatt.disconnect();
        else connect();
    };

    // --- 8. Bluetooth ---
    async function connect() {
        try {
            log("Scanning...");
            device = await navigator.bluetooth.requestDevice({
                filters: [{ services: [SERVICE] }],
                optionalServices: [UUID_S]
            });
            device.addEventListener('gattserverdisconnected', onDisconnect);
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(UUID_S);
            const chars = await service.getCharacteristics();
            for(let c of chars) {
                if(c.uuid === UUID_N) {
                    notifyChar = c;
                    await c.startNotifications();
                    c.addEventListener('characteristicvaluechanged', onNotify);
                }
                if(c.uuid === UUID_W) writeChar = c;
            }
            if(notifyChar && writeChar) {
                state = "handshake";
                send([0x07,0,0,0]);
            }
        } catch(e) { log("Connect Error: " + e.message); }
    }

    function onDisconnect() {
        state = "disconnected";
        ui.statusText.textContent = "Disconnected";
        ui.statusText.style.color = "var(--text-light)";
        ui.connect.textContent = "Connect";
        ui.connect.classList.remove('connected');
        isRunning = false;
        updateDrillButtonStates(); 
        clearTimeout(pauseTimer);
        log("Disconnected");
    }

    async function send(data) {
        if(!writeChar) return;
        const arr = new Uint8Array(data);
        writeLock = writeLock.then(() => writeChar.writeValue(arr).catch(e => log("TX Error: " + e)));
        return writeLock;
    }

    function onNotify(e) {
        const buf = e.target.value.buffer;
        if(state === "handshake") {
            const td = new TextDecoder();
            const str = td.decode(buf);
            if(str.length > 18) {
                const serial = str.slice(6,18);
                const code = str.slice(18);
                let hashme = serial;
                for(let i=0; i<serial.length; i++) hashme += SALT[serial.charCodeAt(i)%0x24];
                hashme += code;
                const hash = MD5(hashme);
                const resp = new Uint8Array(3+hash.length);
                resp.set([0x08,0x20,0,0]);
                resp.set(new TextEncoder().encode(hash),3);
                send(resp);
                state = "auth_1";
            }
        } else if(state === "auth_1") { send([1,0,0]); state = "auth_2"; }
        else if(state === "auth_2") { send([2,0,0]); state = "auth_3"; }
        else if(state === "auth_3") {
            send([0x80,1,0,0]);
            state = "ready";
            ui.statusText.textContent = "Connected";
            ui.statusText.style.color = "#00b894";
            ui.connect.textContent = "Disconnect";
            ui.connect.classList.add('connected');
            updateDrillButtonStates();
            showToast("Connected");
            log("Ready");
        }
        const hex = [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,'0')).join('');
        if(isRunning && hex.includes(MSG_DONE)) handleDone();
    }

    // --- 9. Drill Run Logic ---
    function startDrillSequence(drillName) {
        const params = currentDrills[drillName] ? currentDrills[drillName][selectedLevel] : null;
        if(!params) {
             log("Drill data not found: " + drillName);
             return;
        }
        activeDrillParams = params;
        activeDrillRandom = !!currentDrills[drillName].random;

        ui.runOverlay.classList.add('open');
        // 1. Countdown Setup
        let count = 4;
        ui.runDisplay.textContent = count;
        ui.runLabel.textContent = "GET READY";
        ui.btnPause.style.display = 'none'; 
        
        // Reset Ring Animation
        ui.runProgress.style.transition = 'none';
        ui.runProgress.style.strokeDashoffset = '0';
        void ui.runProgress.offsetWidth; 
        
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                ui.runProgress.style.transition = 'stroke-dashoffset 4s linear';
                ui.runProgress.style.strokeDashoffset = '565'; 
            });
        });

        countdownTimer = setInterval(() => {
            count--;
            if (count > 0) {
                ui.runDisplay.textContent = count;
            } else {
                clearInterval(countdownTimer);
                ui.runDisplay.textContent = "GO!";
                ui.runProgress.style.strokeDashoffset = '565'; // Ensure empty
                
                // Short "GO!" pause before actual drill start
                setTimeout(() => {
                     beginDrillExecution();
                }, 800);
            }
        }, 1000);
    }

    function beginDrillExecution() {
        isRunning = true;
        isPaused = false;
        ui.btnPause.style.display = 'block';
        ui.btnPause.textContent = "PAUSE";
        ui.btnPause.classList.remove('pulse-anim');
        ui.runLabel.textContent = "REMAINING";

        ui.runProgress.style.transition = 'none';
        ui.runProgress.style.strokeDashoffset = '0';
        
        if (runMode === 'time') {
            const tVal = document.getElementById('input-time').value;
            remainingTime = parseInt(tVal);
            ui.runDisplay.textContent = formatTime(remainingTime);
            
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    if(isRunning && !isPaused) {
                        ui.runProgress.style.transition = `stroke-dashoffset ${remainingTime}s linear`;
                        ui.runProgress.style.strokeDashoffset = '565';
                    }
                });
            });

            runTimer = setInterval(() => {
                if (!isPaused) {
                    remainingTime--;
                    ui.runDisplay.textContent = formatTime(remainingTime);
                    if (remainingTime <= 0) {
                        stopRun();
                    }
                }
            }, 1000);

        } else {
            targetCount = parseInt(document.getElementById('input-reps').value) || 1;
            currentCount = 0;
            ui.runDisplay.textContent = targetCount;
            ui.runProgress.style.transition = 'stroke-dashoffset 0.5s ease';
        }
        
        runIteration();
    }

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}:${s.toString().padStart(2,'0')}`;
    }

    async function runIteration() {
        if(!isRunning || isPaused) return;
        
        if (runMode === 'reps') {
            const remaining = targetCount - currentCount;
            ui.runDisplay.textContent = remaining;
            
            // Update Ring Stepwise (Inverted: 0 completed = full ring, target completed = empty ring)
            const fractionCompleted = currentCount / targetCount;
            const offset = 565 * fractionCompleted;
            ui.runProgress.style.strokeDashoffset = offset;

            currentCount++;
        }
        
        let sequence = activeDrillParams;
        if (activeDrillRandom) {
            sequence = [...activeDrillParams]; 
            for (let i = sequence.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [sequence[i], sequence[j]] = [sequence[j], sequence[i]];
            }
        }

        const balls = [];
        sequence.forEach((p, i) => {
            log(`TX Ball ${i+1}: ${p.join(' ')}`);
            balls.push(packBall(p[0], p[1], p[2], p[3], p[4], p[5]));
        });
        
        // Update Stats
        appStats.balls += balls.length;
        appStats.drills += 1;
        localStorage.setItem('nova_stats', JSON.stringify(appStats));
        updateStatsUI();
        
        await send(buildPacket(balls));
    }

    function handleDone() {
        if(!isRunning) return;
        
        if (runMode === 'reps' && currentCount >= targetCount) {
            stopRun();
            return;
        }
        
        const pause = parseInt(ui.inputPause.value);
        if (!isPaused) {
             pauseTimer = setTimeout(() => { if(isRunning && !isPaused) runIteration(); }, pause);
        }
    }

    function togglePause() {
        if (isPaused) {
            // Resume
            isPaused = false;
            ui.btnPause.textContent = "PAUSE";
            ui.btnPause.classList.remove('pulse-anim');
            
            // Resume Ring Animation for Time Mode
            if(runMode === 'time') {
                 ui.runProgress.style.transition = `stroke-dashoffset ${remainingTime}s linear`;
                 ui.runProgress.style.strokeDashoffset = '565';
            }
            
            runIteration(); 
        } else {
            // Pause
            isPaused = true;
            ui.btnPause.textContent = "RESUME";
            ui.btnPause.classList.add('pulse-anim');
            clearTimeout(pauseTimer);
            
            // Freeze Ring
            const computedStyle = window.getComputedStyle(ui.runProgress);
            const currentOffset = computedStyle.getPropertyValue('stroke-dashoffset');
            ui.runProgress.style.transition = 'none';
            ui.runProgress.style.strokeDashoffset = currentOffset;
            
            send([0x80,1,0,1]); 
        }
    }

    function stopRun() {
        isRunning = false;
        isPaused = false;
        clearInterval(countdownTimer);
        clearInterval(runTimer);
        clearTimeout(pauseTimer);
        
        ui.runOverlay.classList.remove('open');
        document.querySelectorAll('.btn-drill').forEach(b => b.classList.remove('running'));
        
        send([0x80,1,0,1]); 
        log("Drill Stopped");
    }

    function packBall(us, ls, bh, dp, freq, reps) {
        const b = new ArrayBuffer(24), v = new DataView(b);
        us = clamp(us, 400, 7500); ls = clamp(ls, 400, 7500);
        const bh_f = (clamp(bh,-50,100)+50)/150*50-20;
        const dp_f = (clamp(dp,-10,10)+10)/20*44-22;
        const fr_f = (clamp(freq,0,100)/100)+0.5;
        v.setUint32(0, us, true); v.setUint32(4, ls, true);
        v.setFloat32(8, bh_f, true); v.setFloat32(12, dp_f, true);
        v.setFloat32(16, fr_f, true); v.setUint32(20, reps, true);
        return new Uint8Array(b);
    }

    function buildPacket(balls) {
        const b = new ArrayBuffer(7 + balls.length*24);
        const v = new DataView(b);
        v.setUint8(0, 0x81); v.setUint16(1, 4+balls.length*24, true);
        v.setUint8(3, 1); v.setUint16(4, 1, true); v.setUint8(6, 0);
        const u = new Uint8Array(b);
        let off = 7;
        balls.forEach(ba => { u.set(ba, off); off+=24; });
        return u;
    }

    var MD5=function(d){var r=M(V(Y(X(d),8*d.length)));return r.toLowerCase()};function M(d){for(var _,m="0123456789ABCDEF",f="",r=0;r<d.length;r++)_=d.charCodeAt(r),f+=m.charAt(_>>>4&15)+m.charAt(15&_);return f}function X(d){for(var _=Array(d.length>>2),m=0;m<_.length;m++)_[m]=0;for(m=0;m<8*d.length;m+=8)_[m>>5]|=(255&d.charCodeAt(m/8))<<m%32;return _}function V(d){for(var _="",m=0;m<32*d.length;m+=8)_+=String.fromCharCode(d[m>>5]>>>m%32&255);return _}function Y(d,_){d[_>>5]|=128<<_%32,d[14+(_+64>>>9<<4)]=_;for(var m=1732584193,f=-271733879,r=-1732584194,i=271733878,n=0;n<d.length;n+=16){var h=m,t=f,g=r,e=i;f=md5_ii(f=md5_ii(f=md5_ii(f=md5_ii(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_ff(f=md5_ff(f=md5_ff(f=md5_ff(f,r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+0],7,-680876936),f,r,d[n+1],12,-389564586),m,f,d[n+2],17,606105819),i,m,d[n+3],22,-1044525330),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+4],7,-176418897),f,r,d[n+5],12,1200080426),m,f,d[n+6],17,-1473231341),i,m,d[n+7],22,-45705983),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+8],7,1770035416),f,r,d[n+9],12,-1958414417),m,f,d[n+10],17,-42063),i,m,d[n+11],22,-1990404162),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+12],7,1804603682),f,r,d[n+13],12,-40341101),m,f,d[n+14],17,-1502002290),i,m,d[n+15],22,1236535329),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+1],5,-165796510),f,r,d[n+6],9,-1069501632),m,f,d[n+11],14,643717713),i,m,d[n+0],20,-373897302),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+5],5,-701558691),f,r,d[n+10],9,38016083),m,f,d[n+15],14,-660478335),i,m,d[n+4],20,-405537848),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+9],5,568446438),f,r,d[n+14],9,-1019803690),m,f,d[n+3],14,-187363961),i,m,d[n+8],20,1163531501),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+13],5,-1444681467),f,r,d[n+2],9,-51403784),m,f,d[n+7],14,1735328473),i,m,d[n+12],20,-1926607734),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+5],4,-378558),f,r,d[n+8],11,-2022574463),m,f,d[n+11],16,1839030562),i,m,d[n+14],23,-35309556),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+1],4,-1530992060),f,r,d[n+4],11,1272893353),m,f,d[n+7],16,-155497632),i,m,d[n+10],23,-1094730640),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+13],4,681279174),f,r,d[n+0],11,-358537222),m,f,d[n+3],16,-722521979),i,m,d[n+6],23,76029189),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+9],4,-640364487),f,r,d[n+12],11,-421815835),m,f,d[n+15],16,530742520),i,m,d[n+2],23,-995338651),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+0],6,-198630844),f,r,d[n+7],10,1126891415),m,f,d[n+14],15,-1416354905),i,m,d[n+5],21,-57434055),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+12],6,1700485571),f,r,d[n+3],10,-1894986606),m,f,d[n+10],15,-1051523),i,m,d[n+1],21,-2054922799),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+8],6,1873313359),f,r,d[n+15],10,-30611744),m,f,d[n+6],15,-1560198380),i,m,d[n+13],21,1309151649),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+4],6,-145523070),f,r,d[n+11],10,-1120210379),m,f,d[n+2],15,718787259),i,m,d[n+9],21,-343485551),m=safe_add(m,h),f=safe_add(f,t),r=safe_add(r,g),i=safe_add(i,e)}return Array(m,f,r,i)}function md5_cmn(d,_,m,f,r,i){return safe_add(bit_rol(safe_add(safe_add(_,d),safe_add(f,i)),r),m)}function md5_ff(d,_,m,f,r,i,n){return md5_cmn(_&m|~_&f,d,_,r,i,n)}function md5_gg(d,_,m,f,r,i,n){return md5_cmn(_&f|m&~f,d,_,r,i,n)}function md5_hh(d,_,m,f,r,i,n){return md5_cmn(_^m^f,d,_,r,i,n)}function md5_ii(d,_,m,f,r,i,n){return md5_cmn(m^(_|~f),d,_,r,i,n)}function safe_add(d,_){var m=(65535&d)+(65535&_);return(d>>16)+(_>>16)+(m>>16)<<16|65535&m}function bit_rol(d,_){return d<<_|d>>>32-_}
</script>

</body>
</html>